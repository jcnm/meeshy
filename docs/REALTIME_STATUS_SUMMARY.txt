â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘          SYSTÃˆME DE STATUT UTILISATEUR EN TEMPS RÃ‰EL - MEESHY               â•‘
â•‘                                                                              â•‘
â•‘                          Architecture Sans Polling                           â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PRINCIPE GÃ‰NÃ‰RAL                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   ğŸš€ Push-Only Architecture (ZÃ‰RO polling client)
   ğŸ“¡ Socket.IO pour Ã©vÃ©nements temps rÃ©el (USER_STATUS)
   ğŸ”„ REST API avec throttling (1x/min) pour activitÃ© silencieuse
   ğŸ¨ Calcul local frontend basÃ© sur lastActiveAt
   âš¡ Garantie temps rÃ©el < 100ms
   ğŸ›¡ï¸ RÃ©silience via job maintenance (cleanup zombies 60s)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLUX CONNEXION UTILISATEUR                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Browser                Gateway              MongoDB           Other Users
      â”‚                      â”‚                    â”‚                   â”‚
      â”œâ”€[1]â”€ Socket.IO â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                   â”‚
      â”‚   connect + JWT      â”‚                    â”‚                   â”‚
      â”‚                      â”œâ”€[2]â”€ UPDATE â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
      â”‚                      â”‚   isOnline=true    â”‚                   â”‚
      â”‚                      â”‚   lastActiveAt=NOW â”‚                   â”‚
      â”‚                      â”‚â—„â”€â”€â”€â”€ OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
      â”‚                      â”‚                    â”‚                   â”‚
      â”‚                      â”œâ”€[3]â”€ Broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                      â”‚   USER_STATUS      â”‚                   â”‚
      â”‚                      â”‚   (isOnline:true)  â”‚                   â”‚
      â”‚â—„â”€[4]â”€ AUTHENTICATED â”€â”¤                    â”‚                   â”‚
      â”‚                      â”‚                    â”‚                   â”‚
      â”‚                      â”‚                    â”‚                   â”‚
      â–¼                      â–¼                    â–¼                   â–¼
   UI: ğŸŸ¢ Online       Logs: "User connected"    DB Updated      UI: ğŸŸ¢ Online

   DurÃ©e totale: ~50-100ms


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLUX ACTIVITÃ‰ REST API (avec Throttling)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Browser              Gateway               MongoDB         Frontend
      â”‚                    â”‚                     â”‚                â”‚
      â”œâ”€[1]â”€ POST â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                     â”‚                â”‚
      â”‚   /api/messages    â”‚                     â”‚                â”‚
      â”‚   Auth: Bearer xyz â”‚                     â”‚                â”‚
      â”‚                    â”œâ”€[2]â”€ Throttle â”€â”€â”€â”€â”€â”€â”¤                â”‚
      â”‚                    â”‚   Check cache       â”‚                â”‚
      â”‚                    â”‚   (1x/min max)      â”‚                â”‚
      â”‚                    â”‚                     â”‚                â”‚
      â”‚                    â”œâ”€[3]â”€ UPDATE? â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
      â”‚                    â”‚   lastActiveAt=NOW  â”‚  (si non throttled)
      â”‚                    â”‚â—„â”€â”€â”€â”€ OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
      â”‚                    â”‚                     â”‚                â”‚
      â”‚â—„â”€[4]â”€ 200 OK â”€â”€â”€â”€â”€â”€â”¤                     â”‚                â”‚
      â”‚   { messageId }    â”‚                     â”‚                â”‚
      â”‚                    â”‚                     â”‚                â”‚
      â”œâ”€[5]â”€ Recalcul Local â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
      â”‚   getUserStatus(user)                    â”‚                â”‚
      â”‚   basÃ© sur lastActiveAt                  â”‚                â”‚
      â”‚                    â”‚                     â”‚                â”‚
      â–¼                    â–¼                     â–¼                â–¼
   UI: Statut          Route handler         DB: lastActiveAt   UI: ğŸŸ¢/ğŸŸ /âšª
   recalculÃ©            exÃ©cutÃ©              mis Ã  jour (async)  (selon seuils)

   FrÃ©quence: Max 1 update/min par utilisateur


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FLUX DÃ‰CONNEXION BRUTALE (Crash Navigateur)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Browser              Socket.IO              MaintenanceService    Other Users
      â”‚                    â”‚                           â”‚                   â”‚
      â–¼ CRASH              â”‚                           â”‚                   â”‚
   (no disconnect event)   â”‚                           â”‚                   â”‚
      â”‚                    â”‚                           â”‚                   â”‚
      â”‚                    â”œâ”€[1]â”€ Heartbeat Timeout â”€â”€â”¤                   â”‚
      â”‚                    â”‚     (10s no pong)         â”‚                   â”‚
      â”‚                    â”‚                           â”‚                   â”‚
      â”‚                    â”œâ”€[2]â”€ Force disconnect â”€â”€â”€â”¤                   â”‚
      â”‚                    â”‚                           â”‚                   â”‚
      â”‚                    â”‚                           â”œâ”€[3]â”€ UPDATE â”€â”€â”€â”€â”€â”€â–ºMongoDB
      â”‚                    â”‚                           â”‚   isOnline=false  â”‚
      â”‚                    â”‚                           â”‚   lastSeen=NOW    â”‚
      â”‚                    â”‚                           â”‚â—„â”€â”€â”€â”€ OK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
      â”‚                    â”‚                           â”‚                   â”‚
      â”‚                    â”‚â—„â”€[4]â”€ Broadcast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
      â”‚                    â”‚   USER_STATUS             â”‚                   â”‚
      â”‚                    â”‚   (isOnline:false) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
      â”‚                    â”‚                           â”‚                   â”‚
      â”‚                    â”‚                           â”‚                   â”‚
                           â”‚                           â”‚                   â–¼
                    Timeout: 10s                 Job: 60s          UI: ğŸŸ  Away
                                                                       ou
                                                                   ğŸŸ  Offline

   Phase 1 (Socket.IO): 10s
   Phase 2 (Job fallback): +60s max
   Total worst case: 70s


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CALCUL STATUT LOCAL (Frontend)                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   getUserStatus(user: User): UserStatus {
     
     const now = Date.now();
     const lastActive = new Date(user.lastActiveAt).getTime();
     const diffMinutes = (now - lastActive) / 60000;
     
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
     â”‚ Condition        â”‚ Statut         â”‚ Couleur  â”‚ Icon â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤
     â”‚ diffMin < 5      â”‚ "online"       â”‚ #10b981  â”‚  ğŸŸ¢  â”‚
     â”‚ 5 â‰¤ diffMin < 30 â”‚ "away"         â”‚ #f59e0b  â”‚  ğŸŸ   â”‚
     â”‚ diffMin â‰¥ 30     â”‚ "offline"      â”‚ #6b7280  â”‚  âšª  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
     
     return { status, color, label };
   }
   
   Performance: ~0.01ms (calcul local, pas de requÃªte rÃ©seau)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MODÃˆLE DE DONNÃ‰ES (MongoDB via Prisma)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   model User {
     id           String   @id @db.ObjectId
     username     String   @unique
     
     // Triple state pour statut prÃ©cis
     isOnline     Boolean  @default(false)   // Flag WebSocket (socket active?)
     lastSeen     DateTime @default(now())   // DerniÃ¨re DÃ‰CONNEXION
     lastActiveAt DateTime @default(now())   // DerniÃ¨re ACTIVITÃ‰ (REST ou WS)
     
     // Autres champs...
   }
   
   model AnonymousParticipant {
     id           String   @id @db.ObjectId
     sessionToken String   @unique
     
     // MÃªme structure statut
     isOnline     Boolean  @default(false)
     lastSeenAt   DateTime @default(now())
     lastActiveAt DateTime @default(now())
   }


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ã‰VÃ‰NEMENTS SOCKET.IO                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   SERVER_EVENTS.USER_STATUS (Server â†’ Client)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ {                                                                       â”‚
   â”‚   userId: "507f1f77bcf86cd799439011",  // ID MongoDB                   â”‚
   â”‚   username: "johndoe",                  // Nom utilisateur             â”‚
   â”‚   isOnline: true                        // true=connect, false=disconnectâ”‚
   â”‚ }                                                                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   Ã‰mis quand:
   - Connexion WebSocket
   - DÃ©connexion WebSocket
   - Job maintenance nettoie zombie
   
   Routing: Broadcast CIBLÃ‰ (seulement conversations de l'utilisateur)
   
   CLIENT_EVENTS: AUCUN pour statuts (systÃ¨me 100% passif cÃ´tÃ© client)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GARANTIES SYSTÃˆME                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ MÃ©trique                 â”‚ Garantie     â”‚ Mesure                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Latence broadcast        â”‚ < 100ms p95  â”‚ Timestamp backend â†’ frontend   â”‚
   â”‚ DÃ©tection zombie         â”‚ < 70s        â”‚ Crash â†’ statut offline         â”‚
   â”‚ PrÃ©cision lastActiveAt   â”‚ Â±60s         â”‚ Throttling REST API            â”‚
   â”‚ Charge DB                â”‚ 1 upd/min/u  â”‚ Throttling protection          â”‚
   â”‚ ScalabilitÃ©              â”‚ 10k users    â”‚ Broadcast ciblÃ©                â”‚
   â”‚ DisponibilitÃ©            â”‚ 99.9%        â”‚ Fallbacks multiples            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONFIGURATION CRITIQUE                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Socket.IO (Backend):
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ pingTimeout: 10000      // 10s - DÃ©tection dÃ©connexion brutale         â”‚
   â”‚ pingInterval: 25000     // 25s - Intervalle heartbeat                  â”‚
   â”‚ connectTimeout: 45000   // 45s - Timeout connexion initiale            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   Job Maintenance:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ OFFLINE_THRESHOLD_MINUTES = 5    // Seuil zombie                       â”‚
   â”‚ setInterval(updateOfflineUsers, 60000)  // Job toutes les 60s          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   Throttling Auth Middleware:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ THROTTLE_INTERVAL = 60000        // 1 minute                           â”‚
   â”‚ throttleCache: Map<userId, timestamp>  // Cache en mÃ©moire             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FICHIERS CLÃ‰S                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   Backend:
   â”œâ”€ gateway/src/services/maintenance.service.ts (387 lignes)
   â”‚  â””â”€ Job maintenance, cleanup zombies, updateUserOnlineStatus
   â”‚
   â”œâ”€ gateway/src/socketio/MeeshySocketIOManager.ts (2000+ lignes)
   â”‚  â””â”€ Gestion Socket.IO, broadcast USER_STATUS, authentification
   â”‚
   â””â”€ gateway/src/middleware/auth.ts (476 lignes)
      â””â”€ Auth unifiÃ© JWT/Session, throttling lastActiveAt
   
   Frontend:
   â”œâ”€ frontend/services/usersService.ts (~300 lignes)
   â”‚  â””â”€ Zustand store, calcul statut, listeners Socket.IO
   â”‚
   â”œâ”€ frontend/components/users/OnlineIndicator.tsx (~50 lignes)
   â”‚  â””â”€ Indicateur visuel statut utilisateur
   â”‚
   â””â”€ frontend/hooks/useRealtimeStatus.ts (~40 lignes)
      â””â”€ Hook React pour statut temps rÃ©el
   
   Shared:
   â”œâ”€ shared/types/socketio-events.ts (589 lignes)
   â”‚  â””â”€ Types Socket.IO (SERVER_EVENTS, CLIENT_EVENTS)
   â”‚
   â””â”€ shared/schema.prisma (779 lignes)
      â””â”€ ModÃ¨le de donnÃ©es (User, AnonymousParticipant)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DOCUMENTS DISPONIBLES                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   1. ARCHITECTURE_REALTIME_STATUS.md (45KB)
      â””â”€ Architecture complÃ¨te, services, monitoring, troubleshooting
      â””â”€ Public: Architectes, Lead Developers, DevOps
      â””â”€ DurÃ©e: 30-45 min
   
   2. ARCHITECTURE_REALTIME_STATUS_DIAGRAMS.md (31KB)
      â””â”€ 10 diagrammes de sÃ©quence Mermaid dÃ©taillÃ©s
      â””â”€ Public: Tous dÃ©veloppeurs, QA, Product Managers
      â””â”€ DurÃ©e: 20-30 min
   
   3. REALTIME_STATUS_QUICK_REFERENCE.md (13KB)
      â””â”€ Cheat sheet, snippets, debug checklist, FAQ
      â””â”€ Public: DÃ©veloppeurs (quotidien), DevOps
      â””â”€ DurÃ©e: 5-10 min
   
   4. REALTIME_STATUS_INDEX.md (12KB)
      â””â”€ Index, parcours lecture, concepts clÃ©s
      â””â”€ Public: Tous
      â””â”€ DurÃ©e: 10-15 min


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CHECKLIST PRÃ‰-DÃ‰PLOIEMENT                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   [âœ“] Job maintenance dÃ©marre automatiquement
   [âœ“] Socket.IO timeouts configurÃ©s (pingTimeout: 10s)
   [âœ“] Auth middleware throttling activÃ© (1x/min)
   [âœ“] Index MongoDB crÃ©Ã©s (isOnline, lastActiveAt)
   [âœ“] Broadcast callback configurÃ© (MaintenanceService â†’ SocketIOManager)
   [âœ“] Frontend listeners installÃ©s (USER_STATUS)
   [âœ“] Tests de charge rÃ©ussis (1000+ utilisateurs)
   [âœ“] Monitoring alertes configurÃ©es
   [âœ“] Logs de debug rÃ©duits (production level: info)
   [âœ“] CORS Socket.IO restreint (production domains seulement)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMMANDES UTILES                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   # Monitoring temps rÃ©el
   curl http://localhost:8000/api/admin/maintenance/stats
   
   # Logs live
   tail -f gateway.log | grep -E "(USER_STATUS|CLEANUP|Broadcast)"
   
   # Utilisateurs en ligne
   mongo meeshy --eval "db.User.count({ isOnline: true })"
   
   # Zombies potentiels
   mongo meeshy --eval "
     db.User.find({
       isOnline: true,
       lastActiveAt: { \$lt: new Date(Date.now() - 5*60*1000) }
     }).count()
   "
   
   # Forcer cleanup zombies
   curl -X POST http://localhost:8000/api/admin/maintenance/cleanup-zombies


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘                         DOCUMENTATION COMPLÃˆTE                               â•‘
â•‘                                                                              â•‘
â•‘   RÃ©digÃ© par: Claude (Anthropic)                                            â•‘
â•‘   Date: 2025-11-03                                                           â•‘
â•‘   Version: 1.0                                                               â•‘
â•‘   Statut: âœ… PrÃªt pour ImplÃ©mentation                                        â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
