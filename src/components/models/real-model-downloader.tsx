'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import { Download, CheckCircle, AlertTriangle, Loader2, Zap } from 'lucide-react';
import { toast } from 'sonner';
import { 
  HuggingFaceTranslationService, 
  type TranslationProgress 
} from '@/services/simplified-translation.service';
import { 
  getAllActiveModels,
  getActiveModelConfig,
  ACTIVE_MODELS,
  type AllowedModelType 
} from '@/lib/simple-model-config';
import { 
  type UnifiedModelConfig 
} from '@/lib/unified-model-config';

// Plus besoin de mapping - utilisation directe des types AllowedModelType

/**
 * Composant pour le t√©l√©chargement des 2 mod√®les actifs configur√©s
 * Plus de liste infinie - Seulement les mod√®les basique et haute performance
 */
export function RealModelDownloader() {
  const [downloadProgress, setDownloadProgress] = useState<Record<string, TranslationProgress>>({});
  const [loadedModels, setLoadedModels] = useState<AllowedModelType[]>([]);

  const modelService = HuggingFaceTranslationService.getInstance();
  
  // R√©cup√©rer les 2 mod√®les actifs
  const activeModels = getAllActiveModels();
  const basicModelConfig = getActiveModelConfig('basic');
  const highModelConfig = getActiveModelConfig('high');

  useEffect(() => {
    // Charger l'√©tat initial des mod√®les
    const updateLoadedModels = () => {
      const stats = modelService.getModelStats();
      setLoadedModels(stats.loadedModels);
    };

    updateLoadedModels();
  }, [modelService]);

  /**
   * T√©l√©charge un mod√®le sp√©cifique
   */
  const downloadModel = async (modelName: AllowedModelType) => {
    try {
      console.log(`üîÑ D√©marrage t√©l√©chargement: ${modelName}`);
      
      await modelService.loadModel(modelName, (progress: TranslationProgress) => {
        setDownloadProgress(prev => ({
          ...prev,
          [modelName]: progress
        }));
      });

      // Mettre √† jour la liste des mod√®les charg√©s
      const stats = modelService.getModelStats();
      setLoadedModels(stats.loadedModels);
      
      // Supprimer la progression une fois termin√©
      setDownloadProgress(prev => {
        const newProgress = { ...prev };
        delete newProgress[modelName];
        return newProgress;
      });

      toast.success(`Mod√®le ${modelName} t√©l√©charg√© avec succ√®s !`);
      
    } catch (error) {
      console.error(`‚ùå Erreur t√©l√©chargement ${modelName}:`, error);
      
      setDownloadProgress(prev => ({
        ...prev,
        [modelName]: {
          modelName,
          status: 'error',
          error: error instanceof Error ? error.message : 'Erreur inconnue'
        }
      }));

      toast.error(`√âchec du t√©l√©chargement de ${modelName}`);
    }
  };

  /**
   * D√©charge un mod√®le de la m√©moire
   */
  const unloadModel = async (modelName: AllowedModelType) => {
    const success = await modelService.unloadModel(modelName);
    if (success) {
      const stats = modelService.getModelStats();
      setLoadedModels(stats.loadedModels);
      toast.success(`Mod√®le ${modelName} d√©charg√©`);
    } else {
      toast.error(`Erreur lors du d√©chargement de ${modelName}`);
    }
  };

  /**
   * Obtient le statut d'un mod√®le
   */
  const getModelStatus = (modelName: AllowedModelType) => {
    if (loadedModels.includes(modelName)) return 'loaded';
    if (downloadProgress[modelName]) return downloadProgress[modelName].status;
    return 'not-downloaded';
  };

  return (
    <div className="space-y-6">
      {/* Header avec statistiques */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Download className="h-5 w-5" />
            Mod√®les de traduction actifs
          </CardTitle>
          <CardDescription>
            Configuration simplifi√©e : 2 mod√®les configur√©s via les variables d&apos;environnement
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="text-center">
              <div className="text-2xl font-bold text-green-600">{loadedModels.length}</div>
              <div className="text-sm text-muted-foreground">Mod√®les charg√©s</div>
            </div>
            <div className="text-center">
              <div className="text-2xl font-bold text-blue-600">2</div>
              <div className="text-sm text-muted-foreground">Mod√®les configur√©s</div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Configuration actuelle */}
      <Card className="border-blue-200">
        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-blue-700">
            <Zap className="h-5 w-5" />
            Configuration active
          </CardTitle>
          <CardDescription>
            Mod√®les configur√©s pour cette instance de Meeshy
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <div className="font-medium text-sm">Mod√®le basique (messages courts) :</div>
              <Badge variant="outline" className="bg-green-50 text-green-700 border-green-200">
                {ACTIVE_MODELS.basicModel}
              </Badge>
              <div className="text-xs text-gray-600">{basicModelConfig.description}</div>
            </div>
            <div className="space-y-2">
              <div className="font-medium text-sm">Mod√®le haute performance (messages complexes) :</div>
              <Badge variant="outline" className="bg-blue-50 text-blue-700 border-blue-200">
                {ACTIVE_MODELS.highModel}
              </Badge>
              <div className="text-xs text-gray-600">{highModelConfig.description}</div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Mod√®les actifs */}
      <div className="space-y-4">
        <h3 className="text-lg font-semibold text-gray-700">
          Mod√®les disponibles (2)
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {activeModels.map(({ config }) => (              <ModelCard 
                key={config.name} 
                config={config} 
                status={getModelStatus(config.name)}
                progress={downloadProgress[config.name]}
                onDownload={() => downloadModel(config.name)}
                onUnload={() => unloadModel(config.name)}
                isRecommended={true}
                isCompatible={true}
              />
          ))}
        </div>
      </div>

      {/* Guide de s√©lection des mod√®les */}
      <Card className="border-gray-200">
        <CardHeader>
          <CardTitle className="text-gray-700">Configuration simplifi√©e</CardTitle>
          <CardDescription>
            Meeshy utilise uniquement 2 mod√®les configurables pour optimiser les performances
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div>
              <h4 className="font-medium text-sm mb-2">üí° Fonctionnement :</h4>
              <ul className="text-sm text-gray-600 space-y-1">
                <li>‚Ä¢ <strong>Mod√®le basique :</strong> Utilis√© pour les messages courts (‚â§50 caract√®res) et simples</li>
                <li>‚Ä¢ <strong>Mod√®le haute performance :</strong> Utilis√© pour les messages longs et complexes</li>
                <li>‚Ä¢ <strong>S√©lection automatique :</strong> L&apos;application choisit le bon mod√®le selon le contexte</li>
                <li>‚Ä¢ <strong>Configuration via .env :</strong> NEXT_PUBLIC_BASIC_MODEL et NEXT_PUBLIC_HIGH_MODEL</li>
              </ul>
            </div>

            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <div className="flex items-start gap-2">
                <AlertTriangle className="h-5 w-5 text-blue-600 mt-0.5" />
                <div>
                  <div className="font-medium text-blue-800 mb-1">Configuration actuelle :</div>
                  <ul className="text-sm text-blue-700 space-y-1">
                    <li>‚Ä¢ Basique : <strong>{ACTIVE_MODELS.basicModel}</strong></li>
                    <li>‚Ä¢ Haute performance : <strong>{ACTIVE_MODELS.highModel}</strong></li>
                    <li>‚Ä¢ Pour changer, modifiez les variables dans .env.local et red√©marrez</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}

/**
 * Composant pour afficher un mod√®le individuel
 */
function ModelCard({ 
  config, 
  status, 
  progress, 
  onDownload, 
  onUnload, 
  isRecommended = false,
  isCompatible = true 
}: {
  config: UnifiedModelConfig;
  status: string;
  progress?: TranslationProgress;
  onDownload: () => void;
  onUnload: () => void;
  isRecommended?: boolean;
  isCompatible?: boolean;
}) {
  const isLoaded = status === 'loaded';
  const isDownloading = status === 'downloading' || status === 'loading';

  return (
    <Card className={`${
      isLoaded ? 'border-green-200 bg-green-50' : 
      isRecommended ? 'border-blue-200 bg-blue-50' :
      !isCompatible ? 'border-red-200 bg-red-50 opacity-75' : ''
    }`}>
      <CardHeader className="pb-3">
        <div className="flex items-center justify-between">
          <CardTitle className="text-lg flex items-center gap-2">
            {config.displayName}
            {isRecommended && <Zap className="h-4 w-4 text-yellow-500" />}
          </CardTitle>
          <Badge 
            style={{ backgroundColor: config.color + '20', color: config.color, borderColor: config.color + '40' }}
            variant="outline"
          >
            {config.family}
          </Badge>
        </div>
        <CardDescription>
          {config.description}
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Caract√©ristiques techniques */}
        <div className="grid grid-cols-2 gap-2 text-xs">
          <div className="flex items-center gap-1">
            <span className="font-medium">Taille:</span>
            <span>{Math.round(config.downloadSize / 1024 * 100) / 100} GB</span>
          </div>
          <div className="flex items-center gap-1">
            <span className="font-medium">RAM:</span>
            <span>{Math.round(config.memoryRequirement / 1024 * 100) / 100} GB</span>
          </div>
          <div className="flex items-center gap-1">
            <span className="font-medium">Qualit√©:</span>
            <span>{config.qualityScore}/10</span>
          </div>
          <div className="flex items-center gap-1">
            <span className="font-medium">Vitesse:</span>
            <span>{config.speedScore}/10</span>
          </div>
        </div>

        {/* Indicateurs de performance */}
        <div className="flex gap-1">
          <Badge variant="outline" className="text-xs">
            {config.performance}
          </Badge>
          <Badge variant="outline" className="text-xs">
            {config.quality}
          </Badge>
          <Badge variant="outline" className="text-xs">
            {config.parameters}
          </Badge>
        </div>

        {/* Statut */}
        <div className="flex items-center gap-2">
          {isLoaded && <CheckCircle className="h-4 w-4 text-green-600" />}
          {isDownloading && <Loader2 className="h-4 w-4 text-blue-600 animate-spin" />}
          {status === 'error' && <AlertTriangle className="h-4 w-4 text-red-600" />}
          {!isCompatible && <AlertTriangle className="h-4 w-4 text-orange-500" />}
          <span className={`text-sm font-medium ${
            isLoaded ? 'text-green-700' :
            isDownloading ? 'text-blue-700' :
            status === 'error' ? 'text-red-700' :
            !isCompatible ? 'text-orange-700' :
            'text-gray-700'
          }`}>
            {!isCompatible ? 'Syst√®me insuffisant' :
             isLoaded ? 'Charg√© en m√©moire' :
             isDownloading ? 'T√©l√©chargement...' :
             status === 'error' ? 'Erreur' :
             'Non t√©l√©charg√©'}
          </span>
        </div>

        {/* Barre de progression */}
        {progress && isDownloading && (
          <div className="space-y-1">
            <Progress value={progress.progress || 0} className="h-2" />
            <div className="flex justify-between text-xs text-gray-600">
              <span>{progress.status === 'downloading' ? 'T√©l√©chargement' : 'Chargement'}</span>
              <span>{Math.round(progress.progress || 0)}%</span>
            </div>
            {/* Affichage des octets t√©l√©charg√©s - non disponible dans TranslationProgress
            {progress.bytesLoaded !== undefined && progress.bytesTotal !== undefined && progress.bytesTotal > 0 && (
              <div className="text-xs text-gray-500 text-center">
                {formatBytes(progress.bytesLoaded)} / {formatBytes(progress.bytesTotal)}
              </div>
            )}
            */}
          </div>
        )}

        {/* Message d'erreur */}
        {status === 'error' && progress?.error && (
          <div className="text-sm text-red-600 bg-red-50 p-2 rounded">
            {progress.error}
          </div>
        )}

        {/* Actions */}
        <div className="flex gap-2">
          {!isLoaded && !isDownloading && isCompatible && (
            <Button
              onClick={onDownload}
              size="sm"
              className="flex-1"
              variant={isRecommended ? "default" : "outline"}
            >
              <Download className="h-4 w-4 mr-2" />
              T√©l√©charger
            </Button>
          )}
          
          {isLoaded && (
            <Button
              onClick={onUnload}
              variant="outline"
              size="sm"
              className="flex-1"
            >
              D√©charger
            </Button>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
