#!/bin/bash

# MongoDB Configuration Script for Meeshy
# This script configures Meeshy to use MongoDB exclusively

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
DEFAULT_DATABASE_IMAGE="mongo:8.0"

# Function to print colored output
print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_header() {
    echo -e "${BLUE}=== $1 ===${NC}"
}

# Function to show help
show_help() {
    echo "Usage: $0 [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  -i, --image IMAGE     Custom MongoDB image (default: mongo:8.0)"
    echo "  -e, --env ENV         Environment: dev or prod (default: dev)"
    echo "  -h, --help            Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0                    # Use default MongoDB 8.0 for development"
    echo "  $0 -i mongo:7.0      # Use MongoDB 7.0 for development"
    echo "  $0 -e prod           # Configure for production"
    echo "  $0 -i mongo:8.0 -e prod  # Use MongoDB 8.0 for production"
    echo ""
    echo "Environment Variables:"
    echo "  DATABASE_IMAGE        Custom MongoDB image"
    echo "  ENVIRONMENT           Environment (dev or prod)"
}

# Function to get database image
get_database_image() {
    local custom_image="$1"
    
    if [ -n "$custom_image" ]; then
        echo "$custom_image"
    else
        echo "$DEFAULT_DATABASE_IMAGE"
    fi
}

# Function to create environment file
create_env_file() {
    local db_image="$1"
    local env="$2"
    
    local env_file=".env.database"
    
    print_status "Creating MongoDB environment file: $env_file"
    
    cat > "$env_file" << EOF
# MongoDB Configuration for Meeshy
# Generated by configure-database.sh

# Environment
ENVIRONMENT=$env

# Database Type (MongoDB only for now)
DATABASE_TYPE=MONGODB

# Database Image
DATABASE_IMAGE=$db_image

# MongoDB Configuration
MONGODB_URL=mongodb://meeshy:MeeshyPassword123@database:27017/meeshy?authSource=admin
MONGODB_DATABASE=meeshy
MONGODB_USER=meeshy
MONGODB_PASSWORD=MeeshyPassword123

# Prisma Configuration (MongoDB)
DATABASE_URL=\$MONGODB_URL
PRISMA_SCHEMA_PATH=./shared/schema.prisma

# Docker Compose File
DOCKER_COMPOSE_FILE=docker-compose.$env.yml
EOF
    
    print_status "Environment file created: $env_file"
}

# Function to create docker-compose symlink
create_docker_compose_symlink() {
    local env="$1"
    
    local compose_file="docker-compose.yml"
    local target_file="docker-compose.$env.yml"
    
    if [ -f "$target_file" ]; then
        print_status "Creating symlink: $compose_file -> $target_file"
        
        # Remove existing symlink or file
        rm -f "$compose_file"
        
        # Create symlink
        ln -sf "$target_file" "$compose_file"
        
        print_status "Symlink created successfully"
    else
        print_error "Target file not found: $target_file"
        exit 1
    fi
}

# Function to show configuration summary
show_summary() {
    local db_image="$1"
    local env="$2"
    
    print_header "MongoDB Configuration Summary"
    echo "Environment: $env"
    echo "Database Type: MongoDB (exclusive)"
    echo "Database Image: $db_image"
    echo ""
    
    echo "MongoDB Configuration:"
    echo "  - Port: 27017"
    echo "  - Database: meeshy"
    echo "  - User: meeshy"
    echo "  - Password: MeeshyPassword123"
    echo "  - Schema: ./shared/schema.prisma"
    echo "  - Prisma Variable: DATABASE_URL"
    echo ""
    
    echo "Files created/updated:"
    echo "  - .env.database (MongoDB configuration)"
    echo "  - docker-compose.yml -> docker-compose.$env.yml (symlink)"
    echo ""
    
    echo "Docker Compose Files:"
    echo "  - docker-compose.dev.yml (development)"
    echo "  - docker-compose.prod.yml (production)"
    echo ""
    
    echo "Next steps:"
    echo "  1. Review the configuration in .env.database"
    echo "  2. Start services: docker-compose up -d"
    echo "  3. Check logs: docker-compose logs -f"
    echo ""
    echo "Environment-specific commands:"
    if [ "$env" = "dev" ]; then
        echo "  - Development: docker-compose -f docker-compose.dev.yml up -d"
        echo "  - Production: docker-compose -f docker-compose.prod.yml up -d"
    else
        echo "  - Development: docker-compose -f docker-compose.dev.yml up -d"
        echo "  - Production: docker-compose -f docker-compose.prod.yml up -d"
    fi
}

# Main script
main() {
    local database_image=""
    local environment="$ENVIRONMENT"
    
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            -i|--image)
                database_image="$2"
                shift 2
                ;;
            -e|--env)
                environment="$2"
                shift 2
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                print_error "Unknown option: $1"
                show_help
                exit 1
                ;;
        esac
    done
    
    # Check if environment variables override defaults
    if [ -n "$DATABASE_IMAGE" ]; then
        database_image="$DATABASE_IMAGE"
    fi
    
    if [ -n "$ENVIRONMENT" ]; then
        environment="$ENVIRONMENT"
    fi
    
    # Validate environment
    case "$environment" in
        dev|prod)
            ;;
        *)
            print_error "Invalid environment: $environment"
            print_error "Valid environments: dev, prod"
            exit 1
            ;;
    esac
    
    # Get database image
    database_image=$(get_database_image "$database_image")
    
    print_header "Configuring Meeshy for MongoDB"
    print_status "Environment: $environment"
    print_status "Database Type: MongoDB (exclusive)"
    print_status "Database Image: $database_image"
    echo ""
    
    # Create environment file
    create_env_file "$database_image" "$environment"
    
    # Create docker-compose symlink
    create_docker_compose_symlink "$environment"
    
    # Show summary
    show_summary "$database_image" "$environment"
    
    print_status "MongoDB configuration completed successfully!"
}

# Run main function
main "$@"
