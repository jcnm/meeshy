<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Conversations Meeshy</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { border-color: #4CAF50; background-color: #f1f8e9; }
        .error { border-color: #f44336; background-color: #ffebee; }
        .info { border-color: #2196F3; background-color: #e3f2fd; }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .disabled { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Conversations Meeshy</h1>
        
        <div class="step info">
            <h3>Configuration</h3>
            <p>Frontend: <code>http://localhost:3100</code></p>
            <p>Backend API: <code>http://localhost:3000</code></p>
        </div>

        <div class="step">
            <h3>√âtape 1: Authentification</h3>
            <button onclick="login()">Se connecter comme admin</button>
            <div id="auth-result"></div>
        </div>

        <div class="step">
            <h3>√âtape 2: Tester l'API des conversations</h3>
            <button onclick="testConversationsAPI()" class="disabled" id="test-conversations-btn">Tester API Conversations</button>
            <div id="conversations-result"></div>
        </div>

        <div class="step">
            <h3>√âtape 3: Tester l'API des messages pour "any"</h3>
            <button onclick="testMessagesAPI()" class="disabled" id="test-messages-btn">Tester API Messages "any"</button>
            <div id="messages-result"></div>
        </div>

        <div class="step">
            <h3>√âtape 4: Configurer le frontend</h3>
            <button onclick="setupFrontend()" class="disabled" id="setup-frontend-btn">Configurer le localStorage</button>
            <div id="frontend-result"></div>
        </div>

        <div class="step">
            <h3>√âtape 5: Ouvrir la page des conversations</h3>
            <button onclick="openConversations()" class="disabled" id="open-conversations-btn">Ouvrir /conversations/any</button>
            <div id="open-result"></div>
        </div>
    </div>

    <script>
        let authToken = null;
        let userData = null;

        function updateStatus(elementId, message, isSuccess = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${isSuccess ? 'success' : 'error'}">${message}</div>`;
        }

        function enableButton(buttonId) {
            const button = document.getElementById(buttonId);
            button.classList.remove('disabled');
        }

        async function login() {
            try {
                const response = await axios.post('http://localhost:3000/auth/login', {
                    email: 'admin@meeshy.com',
                    password: 'password123'
                });

                if (response.data.success) {
                    authToken = response.data.access_token;
                    userData = response.data.user;
                    
                    updateStatus('auth-result', `
                        <h4>‚úÖ Connexion r√©ussie!</h4>
                        <p><strong>Utilisateur:</strong> ${userData.username} (${userData.email})</p>
                        <p><strong>Token:</strong> ${authToken.substring(0, 50)}...</p>
                        <pre>${JSON.stringify(userData, null, 2)}</pre>
                    `);
                    
                    enableButton('test-conversations-btn');
                } else {
                    updateStatus('auth-result', `‚ùå Erreur: ${response.data.message}`, false);
                }
            } catch (error) {
                updateStatus('auth-result', `‚ùå Erreur de connexion: ${error.message}`, false);
            }
        }

        async function testConversationsAPI() {
            try {
                const response = await axios.get('http://localhost:3000/api/conversations', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.data.success) {
                    const conversations = response.data.data;
                    updateStatus('conversations-result', `
                        <h4>‚úÖ ${conversations.length} conversations trouv√©es!</h4>
                        <pre>${JSON.stringify(conversations.slice(0, 2), null, 2)}</pre>
                    `);
                    enableButton('test-messages-btn');
                } else {
                    updateStatus('conversations-result', `‚ùå Erreur: ${response.data.message}`, false);
                }
            } catch (error) {
                updateStatus('conversations-result', `‚ùå Erreur API: ${error.message}`, false);
            }
        }

        async function testMessagesAPI() {
            try {
                const response = await axios.get('http://localhost:3000/api/conversations/any/messages', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.data.success) {
                    const messages = response.data.data.messages;
                    updateStatus('messages-result', `
                        <h4>‚úÖ ${messages.length} messages trouv√©s pour "any"!</h4>
                        <p><strong>Premier message:</strong> "${messages[0]?.content}"</p>
                        <p><strong>Dernier message:</strong> "${messages[messages.length - 1]?.content}"</p>
                        <pre>${JSON.stringify(messages.slice(0, 2), null, 2)}</pre>
                    `);
                    enableButton('setup-frontend-btn');
                } else {
                    updateStatus('messages-result', `‚ùå Erreur: ${response.data.message}`, false);
                }
            } catch (error) {
                updateStatus('messages-result', `‚ùå Erreur API: ${error.message}`, false);
            }
        }

        function setupFrontend() {
            try {
                // Configurer le localStorage pour le frontend
                localStorage.setItem('auth_token', authToken);
                localStorage.setItem('user', JSON.stringify(userData));
                
                updateStatus('frontend-result', `
                    <h4>‚úÖ localStorage configur√©!</h4>
                    <p>Token et donn√©es utilisateur sauvegard√©es.</p>
                    <p>Le frontend devrait maintenant reconna√Ætre l'utilisateur connect√©.</p>
                `);
                
                enableButton('open-conversations-btn');
            } catch (error) {
                updateStatus('frontend-result', `‚ùå Erreur localStorage: ${error.message}`, false);
            }
        }

        function openConversations() {
            try {
                // Ouvrir la page des conversations dans un nouvel onglet
                window.open('http://localhost:3100/conversations/any', '_blank');
                
                updateStatus('open-result', `
                    <h4>‚úÖ Page ouverte!</h4>
                    <p>La page <code>/conversations/any</code> s'ouvre dans un nouvel onglet.</p>
                    <p>V√©rifiez si les messages s'affichent correctement.</p>
                    <p>Ouvrez les outils de d√©veloppement (F12) pour voir les logs de console.</p>
                `);
            } catch (error) {
                updateStatus('open-result', `‚ùå Erreur: ${error.message}`, false);
            }
        }
    </script>
</body>
</html>
