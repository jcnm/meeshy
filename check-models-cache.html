<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V√©rification Cache des Mod√®les - Meeshy</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        .status.success { background: #dcfce7; color: #166534; }
        .status.error { background: #fef2f2; color: #dc2626; }
        .status.warning { background: #fef3c7; color: #d97706; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }
        .card h3 {
            margin: 0 0 12px 0;
            color: #1e293b;
            font-size: 16px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        .info-item:last-child { border-bottom: none; }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 4px;
        }
        .btn:hover { background: #2563eb; }
        .btn.secondary { background: #64748b; }
        .btn.secondary:hover { background: #475569; }
        .log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-bar {
            height: 100%;
            background: #3b82f6;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç V√©rification Cache des Mod√®les</h1>
            <p>Diagnostic complet du syst√®me de cache et des mod√®les TensorFlow.js</p>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üì¶ IndexedDB</h3>
                <div class="info-item">
                    <span>Support navigateur</span>
                    <span id="indexeddb-support" class="status">V√©rification...</span>
                </div>
                <div class="info-item">
                    <span>Base de donn√©es</span>
                    <span id="db-status" class="status">En attente</span>
                </div>
                <div class="info-item">
                    <span>Mod√®les en cache</span>
                    <span id="cached-models-count">0</span>
                </div>
                <div class="info-item">
                    <span>Espace utilis√©</span>
                    <span id="cache-size">0 MB</span>
                </div>
            </div>

            <div class="card">
                <h3>üß† TensorFlow.js</h3>
                <div class="info-item">
                    <span>Version TF.js</span>
                    <span id="tf-version">Chargement...</span>
                </div>
                <div class="info-item">
                    <span>Backend actif</span>
                    <span id="tf-backend">D√©tection...</span>
                </div>
                <div class="info-item">
                    <span>Mod√®les charg√©s</span>
                    <span id="loaded-models-count">0</span>
                </div>
                <div class="info-item">
                    <span>M√©moire utilis√©e</span>
                    <span id="memory-usage">0 MB</span>
                </div>
            </div>

            <div class="card">
                <h3>üåê R√©seau & T√©l√©chargement</h3>
                <div class="info-item">
                    <span>Connexion</span>
                    <span id="network-status" class="status">Online</span>
                </div>
                <div class="info-item">
                    <span>Mod√®les disponibles</span>
                    <span id="available-models">Scan...</span>
                </div>
                <div class="info-item">
                    <span>Dernier t√©l√©chargement</span>
                    <span id="last-download">Jamais</span>
                </div>
            </div>
        </div>

        <div class="container">
            <h3>üõ†Ô∏è Actions de Diagnostic</h3>
            <button class="btn" onclick="checkIndexedDB()">üîç V√©rifier IndexedDB</button>
            <button class="btn" onclick="scanLocalModels()">üìÅ Scanner Mod√®les Locaux</button>
            <button class="btn" onclick="testModelDownload()">‚¨áÔ∏è Test T√©l√©chargement</button>
            <button class="btn secondary" onclick="clearCache()">üóëÔ∏è Vider Cache</button>
            <button class="btn secondary" onclick="refreshAll()">üîÑ Actualiser</button>
        </div>

        <div class="container">
            <h3>üìã D√©tails des Mod√®les en Cache</h3>
            <div id="models-details"></div>
        </div>

        <div class="container">
            <h3>üìä Journal des Op√©rations</h3>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script>
        // Variables globales
        let db = null;
        let modelCache = null;
        const log = document.getElementById('log');

        // Fonction de logging
        function logMessage(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            log.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(`${prefix} ${message}`);
        }

        // Initialisation
        async function init() {
            logMessage('üöÄ Initialisation du diagnostic des mod√®les');
            
            // V√©rifier IndexedDB
            await checkIndexedDBSupport();
            
            // V√©rifier TensorFlow.js
            await checkTensorFlowJS();
            
            // Scanner les mod√®les
            await scanLocalModels();
            
            // V√©rifier le cache
            await checkIndexedDB();
            
            logMessage('‚úÖ Diagnostic initial termin√©');
        }

        // V√©rification du support IndexedDB
        async function checkIndexedDBSupport() {
            const supported = 'indexedDB' in window;
            const supportElement = document.getElementById('indexeddb-support');
            
            if (supported) {
                supportElement.textContent = 'Support√©';
                supportElement.className = 'status success';
                logMessage('IndexedDB est support√© par le navigateur');
            } else {
                supportElement.textContent = 'Non support√©';
                supportElement.className = 'status error';
                logMessage('IndexedDB n\'est pas support√© par ce navigateur', 'error');
            }
        }

        // V√©rification TensorFlow.js
        async function checkTensorFlowJS() {
            try {
                if (typeof tf !== 'undefined') {
                    document.getElementById('tf-version').textContent = tf.version.tfjs;
                    document.getElementById('tf-backend').textContent = tf.getBackend();
                    
                    const memoryInfo = tf.memory();
                    document.getElementById('memory-usage').textContent = 
                        `${(memoryInfo.numBytes / 1024 / 1024).toFixed(1)} MB`;
                    
                    logMessage(`TensorFlow.js ${tf.version.tfjs} charg√© avec backend ${tf.getBackend()}`);
                } else {
                    logMessage('TensorFlow.js non disponible', 'error');
                }
            } catch (error) {
                logMessage(`Erreur lors de la v√©rification TF.js: ${error.message}`, 'error');
            }
        }

        // Scanner les mod√®les locaux
        async function scanLocalModels() {
            logMessage('üîç Scan des mod√®les locaux disponibles...');
            
            const modelPaths = [
                '/models/mt5/model.json',
                '/models/nllb/model.json',
                '/models/mt5-small/model.json',
                '/models/mt5-base/model.json',
                '/models/nllb-distilled-600M/model.json',
                '/models/nllb-1.3B/model.json'
            ];

            let availableCount = 0;
            const availableModels = [];

            for (const path of modelPaths) {
                try {
                    const response = await fetch(path, { method: 'HEAD' });
                    if (response.ok) {
                        availableCount++;
                        availableModels.push(path);
                        logMessage(`‚úÖ Mod√®le trouv√©: ${path}`);
                    }
                } catch (error) {
                    // Mod√®le non disponible, normal
                }
            }

            document.getElementById('available-models').textContent = `${availableCount} disponibles`;
            
            if (availableCount === 0) {
                logMessage('‚ö†Ô∏è Aucun mod√®le local trouv√©', 'warning');
            } else {
                logMessage(`üì¶ ${availableCount} mod√®les locaux disponibles`);
            }
        }

        // V√©rification de la base de donn√©es IndexedDB
        async function checkIndexedDB() {
            logMessage('üîç V√©rification de la base de donn√©es IndexedDB...');
            
            try {
                const dbName = 'meeshy-models-cache';
                const request = indexedDB.open(dbName, 1);
                
                request.onerror = () => {
                    logMessage('‚ùå Erreur lors de l\'ouverture de la base de donn√©es', 'error');
                    document.getElementById('db-status').textContent = 'Erreur';
                    document.getElementById('db-status').className = 'status error';
                };

                request.onsuccess = async (event) => {
                    db = event.target.result;
                    document.getElementById('db-status').textContent = 'Connect√©e';
                    document.getElementById('db-status').className = 'status success';
                    logMessage('‚úÖ Base de donn√©es IndexedDB ouverte avec succ√®s');
                    
                    await listCachedModels();
                };

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    logMessage('üîß Cr√©ation/mise √† jour de la structure de la base de donn√©es');
                    
                    // Cr√©er les stores s'ils n'existent pas
                    if (!db.objectStoreNames.contains('models')) {
                        const modelsStore = db.createObjectStore('models', { keyPath: 'id' });
                        modelsStore.createIndex('family', 'info.family', { unique: false });
                        modelsStore.createIndex('variant', 'info.variant', { unique: false });
                        modelsStore.createIndex('downloadDate', 'info.downloadDate', { unique: false });
                        logMessage('üì¶ Store "models" cr√©√©');
                    }

                    if (!db.objectStoreNames.contains('metadata')) {
                        db.createObjectStore('metadata', { keyPath: 'key' });
                        logMessage('üìä Store "metadata" cr√©√©');
                    }
                };
            } catch (error) {
                logMessage(`‚ùå Erreur IndexedDB: ${error.message}`, 'error');
            }
        }

        // Lister les mod√®les en cache
        async function listCachedModels() {
            if (!db) {
                logMessage('‚ùå Base de donn√©es non disponible', 'error');
                return;
            }

            try {
                const transaction = db.transaction(['models'], 'readonly');
                const store = transaction.objectStore('models');
                const request = store.getAll();

                request.onsuccess = () => {
                    const models = request.result;
                    document.getElementById('cached-models-count').textContent = models.length;
                    
                    let totalSize = 0;
                    const modelsDetailsDiv = document.getElementById('models-details');
                    modelsDetailsDiv.innerHTML = '';

                    if (models.length === 0) {
                        modelsDetailsDiv.innerHTML = '<p style="color: #64748b; font-style: italic;">Aucun mod√®le en cache</p>';
                        logMessage('üì≠ Aucun mod√®le trouv√© en cache');
                    } else {
                        logMessage(`üì¶ ${models.length} mod√®les trouv√©s en cache`);
                        
                        models.forEach(model => {
                            totalSize += model.info.fileSize;
                            
                            const modelDiv = document.createElement('div');
                            modelDiv.className = 'card';
                            modelDiv.innerHTML = `
                                <h4>${model.info.family}-${model.info.variant}</h4>
                                <div class="info-item">
                                    <span>Taille</span>
                                    <span>${(model.info.fileSize / 1024 / 1024).toFixed(1)} MB</span>
                                </div>
                                <div class="info-item">
                                    <span>Version</span>
                                    <span>${model.info.version}</span>
                                </div>
                                <div class="info-item">
                                    <span>T√©l√©charg√© le</span>
                                    <span>${new Date(model.info.downloadDate).toLocaleDateString()}</span>
                                </div>
                            `;
                            modelsDetailsDiv.appendChild(modelDiv);
                            
                            logMessage(`üì¶ ${model.info.family}-${model.info.variant}: ${(model.info.fileSize / 1024 / 1024).toFixed(1)} MB`);
                        });
                    }

                    document.getElementById('cache-size').textContent = `${(totalSize / 1024 / 1024).toFixed(1)} MB`;
                };

                request.onerror = () => {
                    logMessage('‚ùå Erreur lors de la lecture des mod√®les en cache', 'error');
                };
            } catch (error) {
                logMessage(`‚ùå Erreur lors de l'√©num√©ration des mod√®les: ${error.message}`, 'error');
            }
        }

        // Test de t√©l√©chargement
        async function testModelDownload() {
            logMessage('üß™ Test de t√©l√©chargement d\'un mod√®le...');
            
            // Simuler un t√©l√©chargement vers une URL de test
            const testUrl = 'https://httpbin.org/json'; // URL de test qui retourne du JSON
            
            try {
                const response = await fetch(testUrl);
                if (response.ok) {
                    logMessage('‚úÖ Test de t√©l√©chargement r√©ussi');
                    document.getElementById('last-download').textContent = new Date().toLocaleTimeString();
                } else {
                    logMessage(`‚ùå Test de t√©l√©chargement √©chou√©: ${response.status}`, 'error');
                }
            } catch (error) {
                logMessage(`‚ùå Erreur de r√©seau: ${error.message}`, 'error');
            }
        }

        // Vider le cache
        async function clearCache() {
            if (!db) {
                logMessage('‚ùå Base de donn√©es non disponible', 'error');
                return;
            }

            if (!confirm('√ätes-vous s√ªr de vouloir vider le cache des mod√®les ?')) {
                return;
            }

            try {
                const transaction = db.transaction(['models'], 'readwrite');
                const store = transaction.objectStore('models');
                const request = store.clear();

                request.onsuccess = () => {
                    logMessage('‚úÖ Cache vid√© avec succ√®s');
                    document.getElementById('cached-models-count').textContent = '0';
                    document.getElementById('cache-size').textContent = '0 MB';
                    document.getElementById('models-details').innerHTML = '<p style="color: #64748b; font-style: italic;">Cache vid√©</p>';
                };

                request.onerror = () => {
                    logMessage('‚ùå Erreur lors du vidage du cache', 'error');
                };
            } catch (error) {
                logMessage(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        // Actualiser toutes les informations
        async function refreshAll() {
            logMessage('üîÑ Actualisation compl√®te...');
            document.getElementById('log').textContent = '';
            await init();
        }

        // V√©rification de l'√©tat du r√©seau
        function checkNetworkStatus() {
            const status = navigator.onLine ? 'Online' : 'Offline';
            const element = document.getElementById('network-status');
            element.textContent = status;
            element.className = navigator.onLine ? 'status success' : 'status error';
        }

        // √âv√©nements r√©seau
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', () => {
            checkNetworkStatus();
            init();
        });
    </script>
</body>
</html>
